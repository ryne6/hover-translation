# PRD: 悬浮框定位与后台连接稳定性

## 背景

- 当前悬浮翻译框 `HoverBox` 在页面存在滚动时仍然使用初始视口坐标，导致位置偏移。
- 内容脚本定期出现 `Could not establish connection. Receiving end does not exist.`，影响翻译功能；需要确认配置加载与后台 Service Worker 生命周期的衔接。

## 目标

1. **定位准确**：无论页面是否滚动，悬浮框都能贴近选中区域显示。
2. **连接可靠**：内容脚本调用后台时保持可用，若后台因休眠或初始化失败，应能自动恢复，并确保配置读取正确。

## 功能需求

### F1. 悬浮框位置修正
- 计算坐标时同时考虑 `window.scrollX/Y` 与视口尺寸、滚动偏移。
- 在滚动或视口较小时，确保悬浮框仍处于视口可见范围。

### F2. 后台连接恢复
- 内容脚本调用后台失败（`Receiving end does not exist`）时，记录失败原因并尝试重新初始化。
- 后台在启动或恢复时需要重新加载配置（`StorageManager.getSettings()`）并校验。
- 若配置缺失或无有效服务，给出友好提示并指导用户重新保存设置。

## 验收标准

- 滚动页面后选择文本，悬浮框依旧贴近文本，不会偏移到屏幕边缘或看不到。
- 翻译过程中不再出现 `Could not establish connection...`；若后台重载，首次消息也能成功响应。
- 保存/重启浏览器后，翻译请求读取到正确的配置（已有服务、生效的主/备设置）。

## Todo List

1. 更新 `calculateOptimalPosition`：
   - 使用视口宽高 + 滚动偏移的约束，保证定位正确。
   - 确保返回的 `x/y` 始终为非负。
2. 内容脚本增强：
   - 对 `chrome.runtime.sendMessage` 失败进行捕获，必要时重试或提示刷新扩展。
3. 后台服务：
   - 确保 Service Worker 启动时重新加载配置并初始化 `APIManager`；
   - 捕获初始化失败时的日志与响应。
4. 补充必要的错误日志和用户提示。
5. 运行现有测试并手动验证滚动 + 翻译流程。
